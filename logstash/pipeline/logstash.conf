# Logstash Pipeline配置文件 - 支持Spring Boot日志收集

input {
  # Beats输入 (用于Filebeat)
  beats {
    port => 5044
  }

  # TCP输入 (用于Spring Boot直接发送日志)
  tcp {
    port => 5000
    codec => json_lines
    type => "spring-boot"
  }

  # UDP输入 (备用)
  udp {
    port => 5000
    codec => json_lines
    type => "spring-boot-udp"
  }
}

filter {
  # 处理Spring Boot日志
  if [type] == "spring-boot" or [type] == "spring-boot-udp" {
    # 确保时间戳格式正确
    if [@timestamp] {
      date {
        match => [ "@timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }

    # 添加Spring Boot特定字段
    mutate {
      add_field => { "[@metadata][index_prefix]" => "spring-boot-logs" }
      add_field => { "log_source" => "spring-boot-application" }
      add_field => { "processed_by" => "logstash" }
    }

    # 解析日志级别并设置优先级
    if [level] {
      if [level] == "ERROR" {
        mutate { add_field => { "priority" => "high" } }
      } else if [level] == "WARN" {
        mutate { add_field => { "priority" => "medium" } }
      } else {
        mutate { add_field => { "priority" => "low" } }
      }
    }

    # 处理异常堆栈信息
    if [stack_trace] {
      mutate {
        add_field => { "has_exception" => "true" }
      }
    }
  }
  # 处理Filebeat日志
  else {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "filebeat-logstash" }
      add_field => { "received_at" => "%{@timestamp}" }
      add_field => { "processed_by" => "logstash" }
    }
  }
}

output {
  # 输出到Elasticsearch - 禁用模板管理
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    user => "elastic"
    password => "elastic123456"
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    manage_template => false
  }

  # 调试输出到控制台
  stdout {
    codec => rubydebug
  }
}
